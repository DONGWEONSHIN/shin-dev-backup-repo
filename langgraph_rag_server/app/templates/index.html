<!doctype html>
<html lang="ko">
  <head>
    <meta
      name="generator"
      content="HTML Tidy for HTML5 for Linux version 5.6.0"
    />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>LangGraph RAG Web</title>
    <link rel="stylesheet" href="/static/style.css" />
  </head>
  <body>
    <h1>LangGraph RAG Web Demo</h1>
    <form id="rag-form" name="rag-form">
      <input
        type="text"
        id="question"
        placeholder="질문을 입력하세요"
        required=""
        style="width: 300px"
      />
      <button type="submit">질문하기</button>
    </form>
    <div id="result" style="margin-top: 20px"></div>
    <hr style="margin: 40px 0" />
    <h2>PDF 업로드</h2>
    <form id="upload-form" enctype="multipart/form-data" name="upload-form">
      <input
        type="file"
        id="pdf-file"
        name="file"
        accept="application/pdf"
        required=""
      />
      <button type="submit">업로드</button>
    </form>
    <div id="upload-result" style="margin-top: 20px"></div>
    <h3>업로드된 PDF 목록</h3>
    <ul id="pdf-list"></ul>
    <script>
      async function fetchPdfList() {
        const res = await fetch("/pdf_list");
        const data = await res.json();
        const list = document.getElementById("pdf-list");
        list.innerHTML = "";
        if (data.pdfs.length === 0) {
          list.innerHTML = "<li>업로드된 PDF가 없습니다.</li>";
        } else {
          data.pdfs.forEach(function (pdf) {
            const li = document.createElement("li");
            li.textContent = pdf + " ";
            const btn = document.createElement("button");
            btn.textContent = "삭제";
            btn.onclick = async function () {
              if (!confirm(pdf + " 파일을 삭제하시겠습니까?")) return;
              const res = await fetch(`/delete_pdf?filename=${encodeURIComponent(pdf)}`, { method: "POST" });
              const result = await res.json();
              alert(result.result);
              fetchPdfList();
            };
            li.appendChild(btn);
            list.appendChild(li);
          });
        }
      }
      document
        .getElementById("rag-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const question = document.getElementById("question").value;
          document.getElementById("result").innerText = "질문 처리 중...";
          const res = await fetch("/api/v1/rag/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question }),
          });
          const data = await res.json();
          document.getElementById("result").innerText = data.answer;
        });

      document
        .getElementById("upload-form")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const fileInput = document.getElementById("pdf-file");
          if (!fileInput.files.length) return;
          const formData = new FormData();
          formData.append("file", fileInput.files[0]);
          document.getElementById("upload-result").innerText =
            "업로드 및 처리 중...";
          const res = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          document.getElementById("upload-result").innerText =
            `${data.filename} 업로드 완료: ${data.result}`;
          // 업로드 후 input[type=file] 값 비우기
          fileInput.value = "";
          // 업로드 결과 메시지 2초 후 자동 삭제
          setTimeout(() => {
            document.getElementById("upload-result").innerText = "";
          }, 2000);
          fetchPdfList();
        });

      // 페이지 로드 시 PDF 목록 표시
      fetchPdfList();
    </script>
  </body>
</html>
